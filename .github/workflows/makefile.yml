name: Build YoudaoNote VIP Tweak (Ellekit + iPhone7 Rootless)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      # 步骤1：检出代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：设置日志
      - name: Setup Log File
        run: |
          LOG_DIR="${{ github.workspace }}/workflow-logs"
          mkdir -p "${LOG_DIR}"
          LOG_FILE="${LOG_DIR}/error.log"
          echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          echo "=== Workflow Start: $(date) ===" > "${LOG_FILE}"
          echo "✅ 日志文件设置完成：${LOG_FILE}"

      # 步骤3：安装基础工具
      - name: Install Basic Tools
        run: |
          echo "=== 安装基础工具 ===" >> "${LOG_FILE}"
          brew update
          brew install ldid dpkg git curl wget make perl xz
          echo "✅ 基础工具安装完成" >> "${LOG_FILE}"

      # 步骤4：安装Theos（完整安装）
      - name: Setup Theos
        run: |
          echo "=== 安装Theos ===" >> "${LOG_FILE}"
          
          # 清理旧环境
          rm -rf ~/theos ~/ellekit ~/iOS-SDKs
          
          # 完整安装Theos（包含子模块）
          echo "正在克隆Theos..." >> "${LOG_FILE}"
          git clone --recursive --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}" || echo "⚠️ Theos克隆失败，尝试继续" >> "${LOG_FILE}"
          
          # 检查是否克隆成功
          if [ ! -d ~/theos ]; then
            echo "❌ Theos克隆失败，尝试非递归克隆" >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}"
            cd ~/theos
            git submodule update --init --recursive 2>&1 >> "${LOG_FILE}"
          fi
          
          # 下载iOS SDK
          echo "下载iOS SDK..." >> "${LOG_FILE}"
          mkdir -p ~/theos/sdks
          cd ~/theos/sdks
          
          # 尝试下载多个版本的SDK
          SDK_URLS=(
            "https://github.com/xybp888/iOS-SDKs/releases/download/14.4/iPhoneOS14.4.sdk.tar.xz"
            "https://github.com/xybp888/iOS-SDKs/releases/download/15.5/iPhoneOS15.5.sdk.tar.xz"
            "https://github.com/xybp888/iOS-SDKs/releases/download/16.4/iPhoneOS16.4.sdk.tar.xz"
          )
          
          SDK_DOWNLOADED=false
          for SDK_URL in "${SDK_URLS[@]}"; do
            echo "尝试下载: $SDK_URL" >> "${LOG_FILE}"
            wget -q --timeout=30 "$SDK_URL" -O sdk.tar.xz 2>&1 >> "${LOG_FILE}" || continue
            if [ -f sdk.tar.xz ]; then
              echo "正在解压SDK..." >> "${LOG_FILE}"
              tar -xf sdk.tar.xz 2>&1 >> "${LOG_FILE}"
              rm -f sdk.tar.xz
              SDK_DOWNLOADED=true
              echo "✅ SDK下载解压成功" >> "${LOG_FILE}"
              break
            fi
          done
          
          if [ "$SDK_DOWNLOADED" = false ]; then
            echo "⚠️ 直接下载失败，尝试备用方案" >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/xybp888/iOS-SDKs.git ~/iOS-SDKs 2>&1 >> "${LOG_FILE}" || echo "⚠️ iOS-SDKs克隆失败" >> "${LOG_FILE}"
            if [ -d ~/iOS-SDKs/iPhoneOS14.4.sdk ]; then
              cp -r ~/iOS-SDKs/iPhoneOS14.4.sdk ~/theos/sdks/ 2>&1 >> "${LOG_FILE}"
              echo "✅ SDK复制完成 (14.4)" >> "${LOG_FILE}"
            elif [ -d ~/iOS-SDKs/iPhoneOS15.5.sdk ]; then
              cp -r ~/iOS-SDKs/iPhoneOS15.5.sdk ~/theos/sdks/ 2>&1 >> "${LOG_FILE}"
              echo "✅ SDK复制完成 (15.5)" >> "${LOG_FILE}"
            fi
          fi
          
          # 验证SDK结构
          echo "检查SDK目录结构..." >> "${LOG_FILE}"
          for sdk in ~/theos/sdks/*.sdk; do
            if [ -d "$sdk" ]; then
              echo "找到SDK: $sdk" >> "${LOG_FILE}"
              if [ -d "$sdk/System/Library/Frameworks/Foundation.framework" ]; then
                echo "✅ $sdk 包含Foundation.framework" >> "${LOG_FILE}"
              else
                echo "❌ $sdk 缺少Foundation.framework" >> "${LOG_FILE}"
              fi
            fi
          done

      # 步骤5：安装和配置Ellekit
      - name: Setup Ellekit
        run: |
          echo "=== 安装Ellekit ===" >> "${LOG_FILE}"
          
          # 克隆Ellekit
          git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "⚠️ Ellekit克隆失败，尝试备用源" >> "${LOG_FILE}"
          
          # 如果主仓库失败，尝试其他源
          if [ ! -d ~/ellekit ]; then
            echo "尝试从备用源克隆Ellekit..." >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/eilla1/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "❌ Ellekit克隆完全失败" >> "${LOG_FILE}"
          fi

      # 步骤6：编译打包
      - name: Build Package
        run: |
          echo "=== 编译打包 ===" >> "${LOG_FILE}"
          
          cd "${{ github.workspace }}"
          
          # 设置环境变量 - 使用绝对路径
          export THEOS=/Users/runner/theos
          export PATH="$PATH:$THEOS/bin:$THEOS/vendor/bin"
          export ARCHS=arm64
          export TARGET=iphone:clang:latest:12.0
          export THEOS_PACKAGE_SCHEME=rootless
          export THEOS_STAGING_DIR=/var/jb
          
          # 查找可用的SDK
          echo "查找可用的SDK..." >> "${LOG_FILE}"
          for sdk in $THEOS/sdks/*.sdk; do
            if [ -d "$sdk" ] && [ -d "$sdk/System/Library/Frameworks/Foundation.framework" ]; then
              export SDKROOT="$sdk"
              echo "✅ 使用SDK: $SDKROOT" >> "${LOG_FILE}"
              break
            fi
          done
          
          if [ -z "$SDKROOT" ]; then
            echo "❌ 未找到包含Foundation.framework的SDK" >> "${LOG_FILE}"
            echo "SDK目录内容:" >> "${LOG_FILE}"
            ls -la $THEOS/sdks/ >> "${LOG_FILE}"
            exit 1
          fi
          
          # 设置Ellekit编译选项
          export CFLAGS="-Wno-error -fobjc-arc -I$THEOS/vendor/ellekit/include"
          export LDFLAGS="-Wl,-dead_strip -L$THEOS/vendor/ellekit/lib -lellekit"
          
          echo "环境变量配置:" >> "${LOG_FILE}"
          echo "THEOS: $THEOS" >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          echo "PATH: $PATH" >> "${LOG_FILE}"
          echo "CFLAGS: $CFLAGS" >> "${LOG_FILE}"
          echo "LDFLAGS: $LDFLAGS" >> "${LOG_FILE}"
          
          # 创建符号链接确保Foundation头文件可访问
          echo "创建符号链接确保头文件可访问..." >> "${LOG_FILE}"
          if [ -d "$SDKROOT/System/Library/Frameworks/Foundation.framework/Headers" ]; then
            # 创建指向Foundation头文件的符号链接
            mkdir -p $THEOS/include/Foundation
            ln -sf "$SDKROOT/System/Library/Frameworks/Foundation.framework/Headers/"* $THEOS/include/Foundation/ 2>&1 >> "${LOG_FILE}" || true
            echo "✅ Foundation头文件符号链接创建完成" >> "${LOG_FILE}"
          fi
          
          # 检查Prefix.pch文件
          echo "检查Prefix.pch文件..." >> "${LOG_FILE}"
          if [ -f "$THEOS/Prefix.pch" ]; then
            echo "Prefix.pch内容:" >> "${LOG_FILE}"
            head -30 "$THEOS/Prefix.pch" >> "${LOG_FILE}"
          fi
          
          # 清理旧构建
          rm -rf .theos packages
          
          # 生成control文件
          echo "Package: com.yncloudnote.vip.tweak" > control
          echo "Name: YNCloudNoteVIP" >> control
          echo "Version: 1.0.0" >> control
          echo "Architecture: iphoneos-arm64" >> control
          echo "Description: YoudaoNote VIP Tweak" >> control
          echo "Author: Your Name" >> control
          echo "Maintainer: Your Name" >> control
          echo "Section: Tweaks" >> control
          echo "Depends: ellekit" >> control
          echo "Rootless: true" >> control
          
          # 尝试构建
          echo "开始构建..." >> "${LOG_FILE}"
          
          # 显示make版本
          make --version >> "${LOG_FILE}" 2>&1 || echo "make命令不可用" >> "${LOG_FILE}"
          
          # 首先运行make clean
          make clean 2>&1 >> "${LOG_FILE}" || echo "⚠️ make clean失败，继续构建" >> "${LOG_FILE}"
          
          # 然后运行make package
          echo "运行 make package..." >> "${LOG_FILE}"
          make package 2>&1 >> "${LOG_FILE}" || {
            echo "❌ 构建失败" >> "${LOG_FILE}"
            # 尝试调试
            echo "调试信息：" >> "${LOG_FILE}"
            echo "当前目录: $(pwd)" >> "${LOG_FILE}"
            echo "文件列表:" >> "${LOG_FILE}"
            ls -la >> "${LOG_FILE}"
            echo "检查SDK中的Foundation头文件:" >> "${LOG_FILE}"
            find "$SDKROOT" -name "Foundation.h" 2>/dev/null | head -5 >> "${LOG_FILE}"
          }
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
          fi

      # 步骤7：上传构建产物
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Artifacts
          path: |
            ${{ github.workspace }}/packages/*.deb
            ${{ github.workspace }}/workflow-logs/error.log
          if-no-files-found: warn
          retention-days: 7

      # 步骤8：上传详细日志
      - name: Upload Detailed Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Detailed-Logs
          path: |
            ${{ github.workspace }}/workflow-logs/
            ~/theos/sdks/
          if-no-files-found: ignore
          retention-days: 7
