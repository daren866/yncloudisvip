name: Build YoudaoNote VIP Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew install ldid dpkg
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
      
      # 步骤 1: 解决“vendor目录缺失”的编译错误
      - name: Initialize Theos Vendor Directory
        run: |
          cd $HOME/theos
          git submodule update --init --recursive
          echo "✅ Theos vendor 目录初始化完成。"

      # 步骤 2: 解决“requires dm.pl”的打包错误
      - name: Setup dm.pl for Theos
        run: |
          mkdir -p $HOME/theos/bin
          cat > $HOME/theos/bin/dm.pl << 'EOF'
          #!/usr/bin/env perl
          use strict;
          use warnings;
          my @args = @ARGV;
          exec('dpkg-deb', @args) or die "无法执行 dpkg-deb: $!";
          EOF
          chmod +x $HOME/theos/bin/dm.pl
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          echo "✅ 已创建并配置 dm.pl 脚本。"

      # 关键修改：彻底移除 deb.mk 中所有多余的括号（替代之前的模糊修复）
      - name: Fix Theos deb.mk Brackets (Force Remove)
        run: |
          DEB_MK_FILE="$HOME/theos/makefiles/package/deb.mk"
          echo "=== 彻底清理 deb.mk 中的多余括号 ==="
          # 备份原文件
          cp "$DEB_MK_FILE" "$DEB_MK_FILE.bak"
          
          # 核心修复：删除文件中所有行的开头(、结尾)，以及中间多余的括号
          # 方式1：暴力替换所有括号（最直接有效）
          sed -i '' 's/[(]//g; s/[)]//g' "$DEB_MK_FILE"
          
          # 方式2（备选）：只删除包含 COPYFILE_DISABLE 的行的括号（更精准）
          # sed -i '' '/COPYFILE_DISABLE/ { s/[(]//g; s/[)]//g; }' "$DEB_MK_FILE"
          
          # 验证修复结果
          echo "=== 验证修复后的关键行 ==="
          grep -n "COPYFILE_DISABLE" "$DEB_MK_FILE" | head -5
          echo "✅ 括号清理完成。"

      # 步骤 3: 原来的编译和打包步骤
      - name: Build Tweak
        run: |
          cd $GITHUB_WORKSPACE
      
          # 1. 强力清理，确保无缓存
          rm -rf .theos
          make clean 2>/dev/null || true
      
          # 2. 关键：强制 dpkg-deb 使用 xz 压缩
          export DEB_BUILD_COMPRESSOR=xz
          export DEB_BUILD_COMPRESSOR_TYPE=xz
      
          # 3. 修补 Theos 压缩配置（lzma 换 xz）
          PATCH_FILE="$HOME/theos/makefiles/package/deb.mk"
          echo "=== 检查并修补压缩配置 ==="
          if grep -q "_THEOS_PLATFORM_DPKG_DEB_COMPRESSION.*lzma" "$PATCH_FILE"; then
            sed -i '' 's/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION.*lzma/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = xz/g' "$PATCH_FILE"
          else
            echo "_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = xz" >> "$PATCH_FILE"
          fi
      
          # 4. 设置 Theos 环境变量
          export THEOS=$HOME/theos
          export THEOS_PACKAGE_SCHEME=rootless
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
      
          # 5. 开始构建和打包
          echo "=== 开始最终构建 ==="
          make package -j$(sysctl -n hw.logicalcpu)  # 启用多线程编译加速
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tweak-Deb
          path: packages/*.deb
