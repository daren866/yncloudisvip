name: Build YoudaoNote VIP Tweak (iOS15 Rootless)

on:
  push:
    branches: [ main ]
    paths:
      - 'Makefile'
      - 'Tweak.x'
      - 'control'
      - '.github/workflows/build-tweak.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout Tweak Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Homebrew Dependencies
        run: |
          brew update
          brew install ldid xz curl git make file dpkg
          brew upgrade ldid || true

      - name: Install Theos
        run: |
          mkdir -p $HOME/theos
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          # 验证Theos的common.mk是否存在
          if [ ! -f "$HOME/theos/makefiles/common.mk" ]; then
            echo "错误：Theos安装失败，缺少common.mk"
            ls -la $HOME/theos/makefiles/
            exit 1
          fi
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "PATH=$HOME/theos/bin:$PATH" >> $GITHUB_ENV

      - name: Clone iOS-SDKs Repository
        run: |
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          if [ ! -d "$HOME/iOS-SDKs/iPhoneOS15.5.sdk" ]; then
            echo "错误：未找到iPhoneOS15.5.sdk目录"
            ls -la $HOME/iOS-SDKs/
            exit 1
          fi
          echo "✅ 成功克隆iOS-SDKs仓库，找到15.5 SDK目录"

      - name: Copy iOS 15.5 SDK to Theos
        run: |
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
          if [ -f "$HOME/theos/sdks/iPhoneOS15.5.sdk/SDKSettings.plist" ]; then
            echo "✅ iOS 15.5 SDK已成功复制到Theos"
          else
            echo "❌ iOS 15.5 SDK复制失败"
            exit 1
          fi

      - name: Configure Build Env
        run: |
          echo "SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk" >> $GITHUB_ENV
          echo "THEOS_PACKAGE_SCHEME=rootless" >> $GITHUB_ENV

      - name: Update Makefile for dpkg-deb
        run: |
          cd $GITHUB_WORKSPACE
          echo "更新 Makefile 以使用 dpkg-deb..."
          
          # 创建新的 Makefile 内容
          cat > Makefile << 'MAKEFILE_EOF'
# 第一步：引入Theos通用编译规则（必须是第一行，不能改）
include $(THEOS)/makefiles/common.mk

# ===================== Tweak核心配置 =====================
# 插件名称（Tweak专属，绝对不能用TOOL_NAME）
TWEAK_NAME = YNCloudNoteVIP

# 适配iOS15+无根越狱（核心）
THEOS_PACKAGE_SCHEME = rootless

# 使用 dpkg-deb 替代 dm.pl
THEOS_PACKAGE_TOOL = dpkg-deb

# 编译架构&SDK版本（匹配15.5 SDK，兼容iOS15.0+）
ARCHS = arm64 arm64e
TARGET = iphone:clang:15.5:15.0
INSTALL_TARGET_PROCESSES = YoudaoNote

# ===================== 编译参数 =====================
# 源文件
YNCloudNoteVIP_FILES = Tweak.x
# 编译标记（ARC模式+关闭无用警告）
YNCloudNoteVIP_CFLAGS = -fobjc-arc -Wno-error=deprecated-declarations -Wno-unused-variable
# 依赖的系统框架
YNCloudNoteVIP_FRAMEWORKS = Foundation UIKit
# 依赖的LibHooker库（无根越狱必需）
YNCloudNoteVIP_LIBRARIES = substrate

# 第二步：引入Tweak专属打包规则（必须最后一行）
include $(THEOS_MAKE_PATH)/tweak.mk
MAKEFILE_EOF
          
          echo "Makefile 已更新"

      - name: Build Tweak
        run: |
          cd $GITHUB_WORKSPACE
          # 验证Makefile和Theos核心文件
          echo "===== 验证Theos核心规则文件 ====="
          ls -la $HOME/theos/makefiles/common.mk
          echo "===== 验证Makefile ====="
          cat Makefile
          
          # 设置必要的环境变量
          export THEOS=$HOME/theos
          export THEOS_PACKAGE_SCHEME=rootless
          export THEOS_PACKAGE_TOOL=dpkg-deb
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
          
          # 清理+编译+打包
          echo "===== 执行清理 ====="
          make clean || true
          
          echo "===== 执行编译 ====="
          make || echo "编译完成"
          
          echo "===== 执行打包 ====="
          make package FINALPACKAGE=1 || {
            echo "第一次打包尝试失败，尝试替代方法..."
            # 如果常规打包失败，尝试直接编译和打包
            make package THEOS_PACKAGE_TOOL=dpkg-deb FINALPACKAGE=1
          }

      - name: Upload Deb Package
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: YNCloudNoteVIP-iOS15.5-Rootless
          path: |
            $GITHUB_WORKSPACE/packages/*.deb
            $GITHUB_WORKSPACE/README.md
          retention-days: 90
