name: Build YoudaoNote VIP Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew install ldid dpkg
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
      
            # 步骤 1: 解决“vendor目录缺失”的编译错误
      - name: Initialize Theos Vendor Directory
        run: |
          cd $HOME/theos
          git submodule update --init --recursive
          echo "✅ Theos vendor 目录初始化完成。"

      # 步骤 2: 解决“requires dm.pl”的打包错误
      - name: Setup dm.pl for Theos
        run: |
          mkdir -p $HOME/theos/bin
          cat > $HOME/theos/bin/dm.pl << 'EOF'
          #!/usr/bin/env perl
          use strict;
          use warnings;
          my @args = @ARGV;
          exec('dpkg-deb', @args) or die "无法执行 dpkg-deb: $!";
          EOF
                    chmod +x $HOME/theos/bin/dm.pl
                    echo "$HOME/theos/bin" >> $GITHUB_PATH
                    echo "✅ 已创建并配置 dm.pl 脚本。"

      - name: Fix Theos Packaging Command Syntax
        run: |
          DEB_MK_FILE="$HOME/theos/makefiles/package/deb.mk"
          echo "正在修复打包命令语法..."
          # 备份原文件
          cp "$DEB_MK_FILE" "$DEB_MK_FILE.backup"
          # 使用sed进行精确修复：找到包含特定模式的行并替换
          sed -i.bak 's/^\s*(COPYFILE_DISABLE=1.*$(FAKEROOT).*-b.*$/COPYFILE_DISABLE=1 $(FAKEROOT) -r dm.pl $(THEOS_PLATFORM_DPKG_DEB_COMPRESSION_FLAG) $(DPKGDEB_FLAGS) -b "$(_THEOS_PLATFORM_DPKG_DEB_BUILD_DPKG_FAKEROOT_PATH)" "$(THEOS_PACKAGE_DIR)\/$(PACKAGE_FILENAME)"/' "$DEB_MK_FILE"
          echo "✅ 已尝试修复打包命令。"
      
      # 步骤 3: 原来的编译和打包步骤
      - name: Build Tweak
        run: |
          cd $GITHUB_WORKSPACE
      
          # 1. 强力清理，确保无缓存
          rm -rf .theos
          make clean 2>/dev/null || true
      
          # 2. 关键：在编译打包前，设置环境变量，强制 dpkg-deb 使用 xz
          # 这是最直接、最有效的一步，会直接影响 dpkg-deb 的行为
          export DEB_BUILD_COMPRESSOR=xz
          export DEB_BUILD_COMPRESSOR_TYPE=xz
      
          # 3. 验证并再次修补 Theos 内部规则
          PATCH_FILE="$HOME/theos/makefiles/package/deb.mk"
          echo "=== 检查并修补打包规则文件 ==="
          if grep -q "_THEOS_PLATFORM_DPKG_DEB_COMPRESSION.*lzma" "$PATCH_FILE"; then
            echo "找到 lzma 配置，正在替换为 xz..."
            sed -i.bak 's/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION.*lzma/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = xz/g' "$PATCH_FILE"
          else
            echo "规则文件中未找到 lzma 配置，尝试直接添加 xz 配置..."
            echo "_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = xz" >> "$PATCH_FILE"
          fi
      
          # 4. 设置必要的 Theos 环境变量
          export THEOS=$HOME/theos
          export THEOS_PACKAGE_SCHEME=rootless
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
      
          # 5. 开始构建和打包
          echo "=== 开始最终构建 ==="
          make package
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tweak-Deb
          path: packages/*.deb
