name: Build YoudaoNote VIP Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      # 步骤1：安装依赖 + 克隆干净的 Theos（不修改任何 Theos 内置文件）
      - name: Install Dependencies & Clean Theos
        run: |
          set +e
          # 安装基础工具
          brew install ldid dpkg fakeroot
          # 清理旧的 Theos 避免污染
          rm -rf $HOME/theos
          # 克隆干净的 Theos（不修改其任何文件）
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
          # 初始化 submodule
          cd $HOME/theos
          git submodule update --init --recursive
          echo "✅ Theos 安装完成（原始未修改版本）。"
          set -e

      # 步骤2：手动编译 Tweak（只编译，不使用 Theos 打包）
      - name: Compile Tweak Manually
        run: |
          set +e
          cd $GITHUB_WORKSPACE
          # 清理缓存
          rm -rf .theos build stage packages
          mkdir -p build stage/DEBIAN stage/Library/MobileSubstrate/DynamicLibraries
          
          # 设置编译环境变量
          export THEOS=$HOME/theos
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
          export ARCHS="arm64 arm64e"
          export TARGET=iphone:clang:15.5:14.0
          export CFLAGS="-fobjc-arc -Wno-deprecated-declarations"
          export LDFLAGS="-dynamiclib -framework Foundation -framework UIKit"
          
          # 1. 预编译 Tweak.x（Logos 语法转 Objective-C）
          echo "=== 预编译 Logos 语法 ==="
          $THEOS/bin/nic.pl > /dev/null 2>&1 # 初始化 nic 避免报错
          $THEOS/bin/logos.pl Tweak.x > build/Tweak.m
          
          # 2. 编译成目标文件（arm64 + arm64e）
          echo "=== 编译 arm64 架构 ==="
          clang -arch arm64 -isysroot $SDKROOT -c build/Tweak.m -o build/Tweak-arm64.o $CFLAGS
          echo "=== 编译 arm64e 架构 ==="
          clang -arch arm64e -isysroot $SDKROOT -c build/Tweak.m -o build/Tweak-arm64e.o $CFLAGS
          
          # 3. 链接成动态库（合并架构）
          echo "=== 链接动态库 ==="
          ldid -Sent.plist build/Tweak # 先准备签名文件（如果有）
          lipo -create build/Tweak-arm64.o build/Tweak-arm64e.o -output build/Tweak.o
          clang -arch arm64 -arch arm64e -isysroot $SDKROOT -shared build/Tweak.o -o stage/Library/MobileSubstrate/DynamicLibraries/YNCloudNoteVIP.dylib $LDFLAGS
          
          # 4. 签名动态库
          echo "=== 签名动态库 ==="
          ldid -Sent.plist stage/Library/MobileSubstrate/DynamicLibraries/YNCloudNoteVIP.dylib
          
          # 5. 复制 plist 文件（Tweak 配置）
          cp Tweak.plist stage/Library/MobileSubstrate/DynamicLibraries/
          echo "✅ Tweak 编译完成，已生成动态库。"
          set -e

      # 步骤3：手动打包 deb 包（绕开 Theos 的 deb.mk）
      - name: Package DEB Manually
        run: |
          set +e
          cd $GITHUB_WORKSPACE
          mkdir -p packages
          
          # 1. 创建 DEBIAN/control 文件（deb 包必需）
          echo "=== 创建 DEBIAN 控制文件 ==="
          cat > stage/DEBIAN/control << 'EOF'
          Package: com.yncloudnote.vip.tweak
          Name: YNCloudNoteVIP
          Version: 0.0.1-1
          Architecture: iphoneos-arm
          Description: YoudaoNote VIP Tweak
          Author: Your Name
          Maintainer: Your Name
          Section: Tweaks
          Depends: mobilesubstrate
          Homepage: https://github.com/your-repo
          Priority: optional
          EOF
          
          # 2. 设置权限
          chmod 0755 stage/DEBIAN
          chmod 0644 stage/DEBIAN/control
          
          # 3. 用 dpkg-deb 手动打包（强制 xz 压缩）
          echo "=== 手动打包 deb 包 ==="
          dpkg-deb -Zxz -b stage packages/com.yncloudnote.vip.tweak_0.0.1-1_iphoneos-arm.deb
          
          # 验证产物
          ls -la packages/*.deb
          if [ -f "packages/com.yncloudnote.vip.tweak_0.0.1-1_iphoneos-arm.deb" ]; then
            echo "✅ deb 包生成成功！"
          else
            echo "❌ deb 包生成失败！"
            exit 1
          fi
          set -e

      # 步骤4：上传产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tweak-Deb
          path: packages/*.deb
          if-no-files-found: error # 没包则标记失败
