name: Build YoudaoNote VIP Tweak (Ellekit + iPhone7 Rootless)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      # 步骤1：检出代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：设置日志
      - name: Setup Log File
        run: |
          LOG_DIR="${{ github.workspace }}/workflow-logs"
          mkdir -p "${LOG_DIR}"
          LOG_FILE="${LOG_DIR}/error.log"
          echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          echo "=== Workflow Start: $(date) ===" > "${LOG_FILE}"
          echo "✅ 日志文件设置完成：${LOG_FILE}"

      # 步骤3：安装基础工具
      - name: Install Basic Tools
        run: |
          echo "=== 安装基础工具 ===" >> "${LOG_FILE}"
          brew update
          brew install ldid dpkg git curl wget make perl
          echo "✅ 基础工具安装完成" >> "${LOG_FILE}"

      # 步骤4：安装Theos（完整安装）
      - name: Setup Theos
        run: |
          echo "=== 安装Theos ===" >> "${LOG_FILE}"
          
          # 清理旧环境
          rm -rf ~/theos ~/ellekit ~/iOS-SDKs
          
          # 完整安装Theos（包含子模块）
          echo "正在克隆Theos..." >> "${LOG_FILE}"
          git clone --recursive --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}" || echo "⚠️ Theos克隆失败，尝试继续" >> "${LOG_FILE}"
          
          # 检查是否克隆成功
          if [ ! -d ~/theos ]; then
            echo "❌ Theos克隆失败，尝试非递归克隆" >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}"
            cd ~/theos
            git submodule update --init --recursive 2>&1 >> "${LOG_FILE}"
          fi
          
          # 下载iOS SDK
          echo "下载iOS SDK..." >> "${LOG_FILE}"
          mkdir -p ~/theos/sdks
          cd ~/theos/sdks
          
          # 尝试下载多个版本的SDK
          SDK_URLS=(
            "https://github.com/xybp888/iOS-SDKs/releases/download/16.4/iPhoneOS16.4.sdk.tar.xz"
            "https://github.com/xybp888/iOS-SDKs/releases/download/14.4/iPhoneOS14.4.sdk.tar.xz"
            "https://github.com/xybp888/iOS-SDKs/releases/download/15.5/iPhoneOS15.5.sdk.tar.xz"
          )
          
          SDK_DOWNLOADED=false
          for SDK_URL in "${SDK_URLS[@]}"; do
            echo "尝试下载: $SDK_URL" >> "${LOG_FILE}"
            wget -q --timeout=30 "$SDK_URL" -O sdk.tar.xz 2>&1 >> "${LOG_FILE}" || continue
            if [ -f sdk.tar.xz ]; then
              tar -xf sdk.tar.xz 2>&1 >> "${LOG_FILE}"
              rm -f sdk.tar.xz
              SDK_DOWNLOADED=true
              echo "✅ SDK下载解压成功" >> "${LOG_FILE}"
              break
            fi
          done
          
          if [ "$SDK_DOWNLOADED" = false ]; then
            echo "⚠️ 直接下载失败，尝试备用方案" >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/xybp888/iOS-SDKs.git ~/iOS-SDKs 2>&1 >> "${LOG_FILE}" || echo "⚠️ iOS-SDKs克隆失败" >> "${LOG_FILE}"
            if [ -d ~/iOS-SDKs/iPhoneOS14.4.sdk ]; then
              cp -r ~/iOS-SDKs/iPhoneOS14.4.sdk ~/theos/sdks/ 2>&1 >> "${LOG_FILE}"
              echo "✅ SDK复制完成" >> "${LOG_FILE}"
            elif [ -d ~/iOS-SDKs/iPhoneOS15.5.sdk ]; then
              cp -r ~/iOS-SDKs/iPhoneOS15.5.sdk ~/theos/sdks/ 2>&1 >> "${LOG_FILE}"
              echo "✅ SDK复制完成" >> "${LOG_FILE}"
            fi
          fi
          
          # 验证dm.pl是否存在
          if [ -f ~/theos/bin/dm.pl ]; then
            echo "✅ dm.pl 文件存在" >> "${LOG_FILE}"
            chmod +x ~/theos/bin/dm.pl
          else
            echo "❌ dm.pl 文件不存在，尝试修复..." >> "${LOG_FILE}"
            # 尝试从其他位置复制或下载dm.pl
            if [ ! -f ~/theos/bin/dm.pl ]; then
              echo "正在下载dm.pl..." >> "${LOG_FILE}"
              wget -q https://raw.githubusercontent.com/theos/theos/master/bin/dm.pl -O ~/theos/bin/dm.pl 2>&1 >> "${LOG_FILE}" || true
              if [ -f ~/theos/bin/dm.pl ]; then
                chmod +x ~/theos/bin/dm.pl
                echo "✅ dm.pl 已下载并设置可执行权限" >> "${LOG_FILE}"
              fi
            fi
          fi

      # 步骤5：安装和配置Ellekit
      - name: Setup Ellekit
        run: |
          echo "=== 安装Ellekit ===" >> "${LOG_FILE}"
          
          # 克隆Ellekit
          git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "⚠️ Ellekit克隆失败，尝试备用源" >> "${LOG_FILE}"
          
          # 如果主仓库失败，尝试其他源
          if [ ! -d ~/ellekit ]; then
            echo "尝试从备用源克隆Ellekit..." >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/eilla1/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "❌ Ellekit克隆完全失败" >> "${LOG_FILE}"
          fi
          
          # 复制Ellekit文件到Theos
          if [ -d ~/ellekit ]; then
            echo "复制Ellekit文件到Theos..." >> "${LOG_FILE}"
            mkdir -p ~/theos/vendor/ellekit
            
            # 复制头文件
            if [ -d ~/ellekit/include ]; then
              cp -r ~/ellekit/include ~/theos/vendor/ellekit/ 2>&1 >> "${LOG_FILE}"
              echo "✅ Ellekit头文件复制完成" >> "${LOG_FILE}"
            fi
            
            # 复制库文件
            if [ -d ~/ellekit/lib ]; then
              cp -r ~/ellekit/lib ~/theos/vendor/ellekit/ 2>&1 >> "${LOG_FILE}"
              echo "✅ Ellekit库文件复制完成" >> "${LOG_FILE}"
            fi
            
            # 如果lib目录为空，尝试构建ellekit
            if [ ! -f ~/theos/vendor/ellekit/lib/libellekit.dylib ]; then
              echo "尝试构建Ellekit..." >> "${LOG_FILE}"
              cd ~/ellekit
              make 2>&1 >> "${LOG_FILE}" || echo "⚠️ Ellekit构建失败" >> "${LOG_FILE}"
              
              # 复制构建好的库
              if [ -f ~/ellekit/.theos/obj/libellekit.dylib ]; then
                mkdir -p ~/theos/vendor/ellekit/lib
                cp ~/ellekit/.theos/obj/libellekit.dylib ~/theos/vendor/ellekit/lib/ 2>&1 >> "${LOG_FILE}"
                echo "✅ Ellekit库构建并复制完成" >> "${LOG_FILE}"
              fi
            fi
          else
            echo "❌ Ellekit目录不存在，跳过配置" >> "${LOG_FILE}"
          fi

      # 步骤6：修复deb.mk和配置环境
      - name: Fix Theos Configuration
        run: |
          echo "=== 修复Theos配置 ===" >> "${LOG_FILE}"
          
          # 修复deb.mk中的dm.pl路径
          DEB_MK=~/theos/makefiles/package/deb.mk
          if [ -f "${DEB_MK}" ]; then
            # 备份原始文件
            cp "${DEB_MK}" "${DEB_MK}.bak"
            
            # 修复dm.pl路径
            sed -i '' 's|\$\(THEOS_BIN_PATH\)/dm.pl|~/theos/bin/dm.pl|g' "${DEB_MK}" 2>&1 >> "${LOG_FILE}" || true
            
            # 修复COPYFILE_DISABLE问题
            sed -i '' 's|COPYFILE_DISABLE=1|COPYFILE_DISABLE=1; export COPYFILE_DISABLE|g' "${DEB_MK}" 2>&1 >> "${LOG_FILE}" || true
            
            echo "✅ deb.mk修复完成" >> "${LOG_FILE}"
          fi
          
          # 确保dm.pl可执行
          if [ -f ~/theos/bin/dm.pl ]; then
            chmod +x ~/theos/bin/dm.pl
            echo "✅ dm.pl设置为可执行" >> "${LOG_FILE}"
          fi
          
          # 添加Theos到PATH
          echo "export THEOS=~/theos" >> ~/.zshrc
          echo "export PATH=\$PATH:~/theos/bin:~/theos/vendor/bin" >> ~/.zshrc
          source ~/.zshrc
          
          echo "✅ Theos环境配置完成" >> "${LOG_FILE}"

      # 步骤7：编译打包
      - name: Build Package
        run: |
          echo "=== 编译打包 ===" >> "${LOG_FILE}"
          
          cd "${{ github.workspace }}"
          
          # 设置环境变量
          export THEOS=~/theos
          export PATH="$PATH:~/theos/bin:~/theos/vendor/bin"
          export ARCHS=arm64
          export TARGET=iphone:clang:latest:12.0
          export THEOS_PACKAGE_SCHEME=rootless
          export THEOS_STAGING_DIR=/var/jb
          
          # 设置SDK路径
          if [ -d ~/theos/sdks/iPhoneOS16.4.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS16.4.sdk
          elif [ -d ~/theos/sdks/iPhoneOS15.5.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS15.5.sdk
          elif [ -d ~/theos/sdks/iPhoneOS14.4.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS14.4.sdk
          else
            echo "❌ 未找到可用的SDK" >> "${LOG_FILE}"
            exit 1
          fi
          
          # 设置Ellekit编译选项
          export CFLAGS="-Wno-error -fobjc-arc -I~/theos/vendor/ellekit/include"
          export LDFLAGS="-Wl,-dead_strip -L~/theos/vendor/ellekit/lib -lellekit"
          
          echo "THEOS: $THEOS" >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          echo "PATH: $PATH" >> "${LOG_FILE}"
          
          # 检查dm.pl是否在PATH中
          which dm.pl >> "${LOG_FILE}" || echo "⚠️ dm.pl不在PATH中" >> "${LOG_FILE}"
          
          # 清理旧构建
          rm -rf .theos packages
          
          # 生成control文件
          echo "Package: com.yncloudnote.vip.tweak" > control
          echo "Name: YNCloudNoteVIP" >> control
          echo "Version: 1.0.0" >> control
          echo "Architecture: iphoneos-arm64" >> control
          echo "Description: YoudaoNote VIP Tweak" >> control
          echo "Author: Your Name" >> control
          echo "Maintainer: Your Name" >> control
          echo "Section: Tweaks" >> control
          echo "Depends: ellekit" >> control
          echo "Rootless: true" >> control
          
          # 尝试构建
          echo "开始构建..." >> "${LOG_FILE}"
          
          # 首先运行make clean
          make clean 2>&1 >> "${LOG_FILE}" || echo "⚠️ make clean失败，继续构建" >> "${LOG_FILE}"
          
          # 然后运行make package
          make package 2>&1 >> "${LOG_FILE}" || {
            echo "❌ 构建失败" >> "${LOG_FILE}"
            # 尝试调试
            echo "调试信息：" >> "${LOG_FILE}"
            echo "当前目录: $(pwd)" >> "${LOG_FILE}"
            echo "文件列表:" >> "${LOG_FILE}"
            ls -la >> "${LOG_FILE}"
            echo "THEOS变量: $THEOS" >> "${LOG_FILE}"
            echo "检查dm.pl:" >> "${LOG_FILE}"
            ls -la ~/theos/bin/dm.pl 2>&1 >> "${LOG_FILE}" || echo "dm.pl不存在" >> "${LOG_FILE}"
          }
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
            echo "尝试手动运行dm.pl..." >> "${LOG_FILE}"
            # 尝试手动运行dm.pl测试
            ~/theos/bin/dm.pl --help 2>&1 >> "${LOG_FILE}" || echo "dm.pl测试失败" >> "${LOG_FILE}"
          fi

      # 步骤8：上传构建产物
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Artifacts
          path: |
            ${{ github.workspace }}/packages/*.deb
            ${{ github.workspace }}/workflow-logs/error.log
          if-no-files-found: warn
          retention-days: 7

      # 步骤9：上传详细日志
      - name: Upload Detailed Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Detailed-Logs
          path: |
            ${{ github.workspace }}/workflow-logs/
            ~/theos/
            ~/ellekit/
          if-no-files-found: ignore
          retention-days: 7
