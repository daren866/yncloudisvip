name: Build YoudaoNote VIP Tweak (Ellekit + iPhone7 Rootless)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      # 步骤1：配置Git并检出代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：设置日志环境变量
      - name: Setup Log File
        run: |
          LOG_DIR="${{ github.workspace }}/workflow-logs"
          mkdir -p "${LOG_DIR}"
          LOG_FILE="${LOG_DIR}/error.log"
          echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          echo "=== Workflow Start: $(date) ===" > "${LOG_FILE}"
          echo "✅ 日志文件设置完成：${LOG_FILE}"

      # 步骤3：安装基础工具
      - name: Install Basic Tools
        run: |
          echo "=== 安装基础工具 ===" >> "${LOG_FILE}"
          brew update
          brew install ldid dpkg git curl wget make
          echo "✅ 基础工具安装完成" >> "${LOG_FILE}"

      # 步骤4：安装和配置Theos
      - name: Setup Theos
        run: |
          echo "=== 安装Theos ===" >> "${LOG_FILE}"
          # 清理旧环境
          rm -rf ~/theos ~/ellekit ~/iOS-SDKs
          
          # 安装Theos
          git clone --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}" || echo "⚠️ Theos克隆失败，尝试继续" >> "${LOG_FILE}"
          
          # 下载iOS SDK
          mkdir -p ~/theos/sdks
          cd ~/theos/sdks
          wget https://github.com/xybp888/iOS-SDKs/releases/download/16.4/iPhoneOS16.4.sdk.tar.xz 2>&1 >> "${LOG_FILE}" || true
          if [ -f iPhoneOS16.4.sdk.tar.xz ]; then
            tar -xf iPhoneOS16.4.sdk.tar.xz 2>&1 >> "${LOG_FILE}"
            echo "✅ SDK下载解压完成" >> "${LOG_FILE}"
          else
            # 备用方案
            git clone --depth 1 https://github.com/xybp888/iOS-SDKs.git ~/iOS-SDKs 2>&1 >> "${LOG_FILE}" || echo "⚠️ iOS-SDKs克隆失败" >> "${LOG_FILE}"
            if [ -d ~/iOS-SDKs/iPhoneOS14.4.sdk ]; then
              cp -r ~/iOS-SDKs/iPhoneOS14.4.sdk ~/theos/sdks/ 2>&1 >> "${LOG_FILE}"
              echo "✅ SDK复制完成" >> "${LOG_FILE}"
            fi
          fi

      # 步骤5：安装Ellekit
      - name: Setup Ellekit
        run: |
          echo "=== 安装Ellekit ===" >> "${LOG_FILE}"
          # 克隆Ellekit
          git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "⚠️ Ellekit克隆失败" >> "${LOG_FILE}"
          
          # 复制Ellekit文件
          mkdir -p ~/theos/vendor/ellekit
          if [ -d ~/ellekit ]; then
            [ -d ~/ellekit/include ] && cp -r ~/ellekit/include ~/theos/vendor/ellekit/ 2>&1 >> "${LOG_FILE}"
            [ -d ~/ellekit/lib ] && cp -r ~/ellekit/lib ~/theos/vendor/ellekit/ 2>&1 >> "${LOG_FILE}"
            echo "✅ Ellekit文件复制完成" >> "${LOG_FILE}"
          fi

      # 步骤6：修复deb.mk
      - name: Fix deb.mk
        run: |
          echo "=== 修复deb.mk ===" >> "${LOG_FILE}"
          DEB_MK=~/theos/makefiles/package/deb.mk
          if [ -f "${DEB_MK}" ]; then
            # 备份原始文件
            cp "${DEB_MK}" "${DEB_MK}.bak"
            # 修复错误
            sed -i '' 's|COPYFILE_DISABLE=1|COPYFILE_DISABLE=1; export COPYFILE_DISABLE|g' "${DEB_MK}" 2>&1 >> "${LOG_FILE}" || true
            echo "✅ deb.mk修复完成" >> "${LOG_FILE}"
          fi

      # 步骤7：编译打包
      - name: Build Package
        run: |
          echo "=== 编译打包 ===" >> "${LOG_FILE}"
          
          cd "${{ github.workspace }}"
          
          # 设置环境变量
          export THEOS=~/theos
          export ARCHS=arm64
          export TARGET=iphone:clang:latest:12.0
          export THEOS_PACKAGE_SCHEME=rootless
          
          # 设置SDK路径
          if [ -d ~/theos/sdks/iPhoneOS16.4.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS16.4.sdk
          elif [ -d ~/theos/sdks/iPhoneOS14.4.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS14.4.sdk
          fi
          
          echo "THEOS: $THEOS" >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          
          # 清理旧构建
          rm -rf .theos packages
          
          # 生成control文件
          cat > control << 'EOF'
Package: com.yncloudnote.vip.tweak
Name: YNCloudNoteVIP
Version: 1.0.0
Architecture: iphoneos-arm64
Description: YoudaoNote VIP Tweak
Author: Your Name
Maintainer: Your Name
Section: Tweaks
Depends: ellekit
Rootless: true
EOF
          
          # 尝试构建
          echo "开始构建..." >> "${LOG_FILE}"
          make clean 2>&1 >> "${LOG_FILE}" || true
          make package 2>&1 >> "${LOG_FILE}" || echo "构建失败" >> "${LOG_FILE}"
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
            echo "当前目录内容：" >> "${LOG_FILE}"
            ls -la >> "${LOG_FILE}"
          fi

      # 步骤8：上传构建产物
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Artifacts
          path: |
            ${{ github.workspace }}/packages/*.deb
            ${{ github.workspace }}/workflow-logs/error.log
            ${{ github.workspace }}/.theos/
          if-no-files-found: warn
          retention-days: 7

      # 步骤9：上传日志
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Workflow-Logs
          path: ${{ github.workspace }}/workflow-logs/
          if-no-files-found: warn
          retention-days: 7
