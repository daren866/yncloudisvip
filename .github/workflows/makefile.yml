name: Build YoudaoNote VIP Tweak (Ellekit + iPhone7 Rootless)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # 步骤0：前置调试（输出Git/SSH核心信息）
      - name: Debug - Git & SSH Config
        run: |
          set -x
          # 输出SSH配置（关键：确认Runner有SSH密钥）
          echo "=== SSH 配置检查 ==="
          ssh -v git@github.com 2>&1 | grep -E "Authenticated|successfully" || echo "⚠️ SSH认证检查（仅看是否连通）"
          # 输出Git凭证配置（彻底清空）
          echo "=== Git 凭证配置 ==="
          git config --global --unset-all credential.helper
          git config --global --unset core.askpass
          git config --global credential.helper "false" # 禁用所有凭证助手
          git config --global core.askpass "/bin/false" # 禁用密码请求
          git config --list
          set +x
          echo "✅ 调试信息输出完成"
      
      # 步骤1：安装依赖（SSH克隆 + 彻底禁用凭证请求）
      - name: Install Dependencies (SSH Clone + No Auth)
        run: |
          # 严格模式：任何错误立即终止并输出
          set -euo pipefail
          set -x
          
          # 安装基础工具
          brew update --verbose
          brew install ldid dpkg --verbose
          
          # 清理旧环境
          rm -rf $HOME/theos $HOME/ellekit $HOME/iOS-SDKs
          
          # ========== 核心修复：改用SSH克隆（无需认证）==========
          # GitHub公有仓库SSH克隆格式：git@github.com:用户名/仓库名.git
          echo "=== 克隆Theos（SSH方式）==="
          git clone --depth=1 --single-branch --verbose git@github.com:theos/theos.git $HOME/theos
          
          echo "=== 克隆Ellekit（SSH方式）==="
          git clone --depth=1 --single-branch --verbose git@github.com:ellekit/ellekit.git $HOME/ellekit
          
          echo "=== 克隆iOS-SDKs（SSH方式）==="
          git clone --depth=1 --verbose git@github.com:xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          
          # 恢复目录结构
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS14.4.sdk $HOME/theos/sdks/
          
          # 集成Ellekit到Theos
          mkdir -p $HOME/theos/vendor/ellekit
          cp -r $HOME/ellekit/include $HOME/theos/vendor/ellekit/
          cp -r $HOME/ellekit/lib $HOME/theos/vendor/ellekit/
          
          # 初始化Theos依赖
          cd $HOME/theos
          git submodule update --init --recursive --verbose src/objc
          
          set +x
          echo "✅ Theos + Ellekit 安装完成（SSH克隆，无认证）。"
      
      # 步骤2：修复deb.mk（带详细日志）
      - name: Fix deb.mk (Rootless + iPhone7)
        run: |
          set -euo pipefail
          set -x
          DEB_MK_FILE="$HOME/theos/makefiles/package/deb.mk"
          [ ! -f "$DEB_MK_FILE.safe.bak" ] && cp "$DEB_MK_FILE" "$DEB_MK_FILE.safe.bak"
          
          # 替换打包命令
          sed -i '' '/COPYFILE_DISABLE=1/ c\
          COPYFILE_DISABLE=1 $(FAKEROOT) -r dm.pl $(THEOS_PLATFORM_DPKG_DEB_COMPRESSION_FLAG) $(DPKGDEB_FLAGS) -b "$(_THEOS_PLATFORM_DPKG_DEB_BUILD_DPKG_FAKEROOT_PATH)" "$(THEOS_PACKAGE_DIR)/$(PACKAGE_FILENAME)"
          ' "$DEB_MK_FILE"
          
          # 强制gzip压缩 + Rootless路径
          sed -i '' 's/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = lzma/_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = gzip/g' "$DEB_MK_FILE"
          echo -e "_THEOS_PLATFORM_DPKG_DEB_COMPRESSION = gzip\nTHEOS_STAGING_DIR = /var/jb" >> "$DEB_MK_FILE"
          
          set +x
          echo "✅ deb.mk 修复完成。"
      
      # 步骤3：编译打包（全量日志）
      - name: Build with Theos (Ellekit + Rootless + iPhone7)
        run: |
          set -euo pipefail
          set -x
          cd $GITHUB_WORKSPACE
          rm -rf .theos packages
          make clean 2>/dev/null || true
          
          # 核心配置
          export THEOS=$HOME/theos
          export ARCHS="arm64"
          export TARGET=iphone:clang:14.4:10.0
          export THEOS_PACKAGE_SCHEME=rootless
          export THEOS_STAGING_DIR=/var/jb
          export SDKROOT=$HOME/theos/sdks/iPhoneOS14.4.sdk
          
          # Ellekit编译依赖
          export CFLAGS="-Wno-error -Wno-deprecated-declarations -fobjc-arc -I$HOME/theos/vendor/ellekit/include"
          export LDFLAGS="-Wl,-dead_strip -L$HOME/theos/vendor/ellekit/lib -lEllekit"
          
          # 高效编译配置
          export MAKEFLAGS="-j$(sysctl -n hw.logicalcpu)"
          export DEB_BUILD_COMPRESSOR=gzip
          export DEB_BUILD_COMPRESSOR_TYPE=gzip
          
          # 生成control文件
          cat > control << 'EOF'
          Package: com.yncloudnote.vip.tweak
          Name: YNCloudNoteVIP
          Version: 0.0.1-1
          Architecture: iphoneos-arm
          Description: YoudaoNote VIP Tweak (Ellekit + Rootless + iPhone7)
          Author: Your Name
          Maintainer: Your Name
          Section: Tweaks
          Depends: ellekit (>= 1.0)
          Homepage: https://github.com/your-repo
          Priority: optional
          Rootless: yes
          EOF
          
          # 执行打包（V=2输出最详细日志）
          make package V=2
          
          # 严格验证产物
          ls -la packages/*.deb
          if [ $(ls -1 packages/*.deb 2>/dev/null | wc -l) -eq 0 ]; then
            echo "❌ 未生成deb包！"
            exit 1
          fi
          
          set +x
          echo "✅ 编译完成！"
      
      # 步骤4：上传产物
      - name: Upload Ellekit-Rootless DEB (iPhone7)
        uses: actions/upload-artifact@v4
        with:
          name: YoudaoNoteVIP-Tweak-Ellekit-Rootless-iPhone7 (arm64)
          path: packages/*.deb
          if-no-files-found: error
