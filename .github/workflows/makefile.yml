name: Build YoudaoNote VIP Tweak (Ellekit + iPhone7 Rootless)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 40

    steps:
      # 步骤1：检出代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：设置日志
      - name: Setup Log File
        run: |
          LOG_DIR="${{ github.workspace }}/workflow-logs"
          mkdir -p "${LOG_DIR}"
          LOG_FILE="${LOG_DIR}/error.log"
          echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          echo "=== Workflow Start: $(date) ===" > "${LOG_FILE}"
          echo "✅ 日志文件设置完成：${LOG_FILE}"

      # 步骤3：安装基础工具
      - name: Install Basic Tools
        run: |
          echo "=== 安装基础工具 ===" >> "${LOG_FILE}"
          brew update
          brew install ldid dpkg git curl wget make perl xz
          # 安装Xcode命令行工具
          sudo xcode-select --install 2>&1 >> "${LOG_FILE}" || true
          echo "✅ 基础工具安装完成" >> "${LOG_FILE}"

      # 步骤4：设置Xcode和SDK
      - name: Setup Xcode and SDK
        run: |
          echo "=== 设置Xcode和SDK ===" >> "${LOG_FILE}"
          
          # 确保Xcode命令行工具就绪
          sudo xcode-select --switch /Applications/Xcode.app 2>&1 >> "${LOG_FILE}" || true
          
          # 接受Xcode许可协议
          sudo xcodebuild -license accept 2>&1 >> "${LOG_FILE}" || true
          
          # 获取macOS SDK路径
          MACOS_SDK_PATH=$(xcrun --sdk macosx --show-sdk-path 2>/dev/null || echo "")
          if [ -n "$MACOS_SDK_PATH" ]; then
            echo "✅ macOS SDK路径: $MACOS_SDK_PATH" >> "${LOG_FILE}"
            echo "MACOS_SDK_PATH=${MACOS_SDK_PATH}" >> $GITHUB_ENV
          else
            echo "❌ 无法获取macOS SDK路径" >> "${LOG_FILE}"
          fi
          
          # 获取iOS SDK路径
          IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path 2>/dev/null || echo "")
          if [ -n "$IOS_SDK_PATH" ]; then
            echo "✅ iOS SDK路径: $IOS_SDK_PATH" >> "${LOG_FILE}"
            echo "IOS_SDK_PATH=${IOS_SDK_PATH}" >> $GITHUB_ENV
          else
            echo "❌ 无法获取iOS SDK路径" >> "${LOG_FILE}"
          fi

      # 步骤5：安装和配置Theos
      - name: Setup Theos
        run: |
          echo "=== 安装Theos ===" >> "${LOG_FILE}"
          
          # 清理旧环境
          rm -rf ~/theos ~/ellekit
          
          # 克隆Theos
          echo "正在克隆Theos..." >> "${LOG_FILE}"
          git clone --recursive --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}" || echo "⚠️ Theos克隆失败" >> "${LOG_FILE}"
          
          # 如果克隆失败，尝试备用方法
          if [ ! -d ~/theos ]; then
            echo "尝试备用方法克隆Theos..." >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}"
            cd ~/theos
            git submodule update --init --recursive 2>&1 >> "${LOG_FILE}"
          fi
          
          # 检查macOS SDK路径并创建符号链接
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH" ]; then
            echo "设置macOS SDK符号链接..." >> "${LOG_FILE}"
            mkdir -p ~/theos/sdks
            ln -sf "$MACOS_SDK_PATH" ~/theos/sdks/MacOSX.sdk 2>&1 >> "${LOG_FILE}" || true
            echo "✅ macOS SDK符号链接创建完成" >> "${LOG_FILE}"
          fi
          
          # 检查iOS SDK路径
          if [ -n "$IOS_SDK_PATH" ] && [ -d "$IOS_SDK_PATH" ]; then
            echo "检查iOS SDK完整性..." >> "${LOG_FILE}"
            if [ -d "$IOS_SDK_PATH/System/Library/Frameworks/CoreFoundation.framework" ]; then
              echo "✅ iOS SDK包含CoreFoundation.framework" >> "${LOG_FILE}"
            else
              echo "❌ iOS SDK缺少CoreFoundation.framework" >> "${LOG_FILE}"
            fi
          fi
          
          # 下载iOS SDK（备用）
          echo "下载备用iOS SDK..." >> "${LOG_FILE}"
          mkdir -p ~/theos/sdks
          cd ~/theos/sdks
          
          # 尝试下载完整的iOS SDK
          wget -q --timeout=60 "https://github.com/xybp888/iOS-SDKs/releases/download/14.4/iPhoneOS14.4.sdk.tar.xz" -O sdk.tar.xz 2>&1 >> "${LOG_FILE}" || true
          
          if [ -f sdk.tar.xz ]; then
            echo "解压iOS SDK..." >> "${LOG_FILE}"
            tar -xf sdk.tar.xz 2>&1 >> "${LOG_FILE}"
            rm -f sdk.tar.xz
            
            # 验证SDK完整性
            if [ -d "iPhoneOS14.4.sdk/System/Library/Frameworks/CoreFoundation.framework" ]; then
              echo "✅ 下载的SDK包含CoreFoundation.framework" >> "${LOG_FILE}"
            else
              echo "❌ 下载的SDK不完整" >> "${LOG_FILE}"
            fi
          else
            echo "⚠️ 无法下载备用SDK" >> "${LOG_FILE}"
          fi

      # 步骤6：安装和配置Ellekit
      - name: Setup Ellekit
        run: |
          echo "=== 安装Ellekit ===" >> "${LOG_FILE}"
          
          # 克隆Ellekit
          git clone --depth 1 https://github.com/eilla1/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "⚠️ Ellekit克隆失败" >> "${LOG_FILE}"
          
          # 如果主仓库失败，尝试其他源
          if [ ! -d ~/ellekit ]; then
            echo "尝试从备用源克隆Ellekit..." >> "${LOG_FILE}"
            git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}" || echo "❌ Ellekit克隆完全失败" >> "${LOG_FILE}"
          fi

      # 步骤7：编译打包（使用Xcode自带的SDK）
      - name: Build Package
        run: |
          echo "=== 编译打包 ===" >> "${LOG_FILE}"
          
          cd "${{ github.workspace }}"
          
          # 设置环境变量
          export THEOS=~/theos
          export PATH="$PATH:$THEOS/bin:$THEOS/vendor/bin"
          export ARCHS=arm64
          export TARGET=iphone:clang:latest:12.0
          export THEOS_PACKAGE_SCHEME=rootless
          export THEOS_STAGING_DIR=/var/jb
          
          # 使用Xcode自带的iOS SDK（如果可用）
          if [ -n "$IOS_SDK_PATH" ] && [ -d "$IOS_SDK_PATH" ]; then
            export SDKROOT="$IOS_SDK_PATH"
            echo "✅ 使用Xcode自带的iOS SDK: $SDKROOT" >> "${LOG_FILE}"
          else
            # 使用下载的SDK
            if [ -d ~/theos/sdks/iPhoneOS14.4.sdk ]; then
              export SDKROOT=~/theos/sdks/iPhoneOS14.4.sdk
              echo "✅ 使用下载的iOS SDK: $SDKROOT" >> "${LOG_FILE}"
            else
              echo "❌ 未找到可用的iOS SDK" >> "${LOG_FILE}"
              exit 1
            fi
          fi
          
          # 设置macOS SDK路径用于mach-o头文件
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH" ]; then
            export MACOS_SDKROOT="$MACOS_SDK_PATH"
            echo "✅ 使用macOS SDK: $MACOS_SDKROOT" >> "${LOG_FILE}"
            
            # 创建必要的符号链接
            mkdir -p $THEOS/include/mach-o
            if [ -d "$MACOS_SDKROOT/usr/include/mach-o" ]; then
              ln -sf "$MACOS_SDKROOT/usr/include/mach-o/"* $THEOS/include/mach-o/ 2>&1 >> "${LOG_FILE}" || true
              echo "✅ mach-o头文件符号链接创建完成" >> "${LOG_FILE}"
            fi
          fi
          
          # 设置Ellekit编译选项
          export CFLAGS="-Wno-error -fobjc-arc"
          if [ -d ~/theos/vendor/ellekit/include ]; then
            export CFLAGS="$CFLAGS -I~/theos/vendor/ellekit/include"
          fi
          
          export LDFLAGS="-Wl,-dead_strip"
          if [ -d ~/theos/vendor/ellekit/lib ]; then
            export LDFLAGS="$LDFLAGS -L~/theos/vendor/ellekit/lib -lellekit"
          fi
          
          echo "环境变量配置:" >> "${LOG_FILE}"
          echo "THEOS: $THEOS" >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          echo "MACOS_SDKROOT: $MACOS_SDKROOT" >> "${LOG_FILE}"
          echo "CFLAGS: $CFLAGS" >> "${LOG_FILE}"
          echo "LDFLAGS: $LDFLAGS" >> "${LOG_FILE}"
          
          # 清理旧构建
          rm -rf .theos packages
          
          # 检查SDK中的关键头文件
          echo "检查关键头文件是否存在:" >> "${LOG_FILE}"
          if [ -d "$SDKROOT" ]; then
            echo "CoreFoundation.h: $(find "$SDKROOT" -name "CoreFoundation.h" 2>/dev/null | head -1)" >> "${LOG_FILE}"
            echo "Foundation.h: $(find "$SDKROOT" -name "Foundation.h" 2>/dev/null | head -1)" >> "${LOG_FILE}"
          fi
          
          if [ -n "$MACOS_SDKROOT" ]; then
            echo "mach-o/nlist.h: $(find "$MACOS_SDKROOT" -name "nlist.h" 2>/dev/null | head -1)" >> "${LOG_FILE}"
          fi
          
          # 生成control文件
          cat > control << 'EOF'
Package: com.yncloudnote.vip.tweak
Name: YNCloudNoteVIP
Version: 1.0.0
Architecture: iphoneos-arm64
Description: YoudaoNote VIP Tweak
Author: Your Name
Maintainer: Your Name
Section: Tweaks
Depends: ellekit
Rootless: true
EOF
          
          # 创建自定义的Prefix.pch文件，避免使用有问题的默认文件
          cat > custom.pch << 'EOF'
#ifdef __OBJC__
    #import <Foundation/Foundation.h>
    #import <UIKit/UIKit.h>
#endif
EOF
          
          # 备份原始的Prefix.pch并替换
          if [ -f "$THEOS/Prefix.pch" ]; then
            mv "$THEOS/Prefix.pch" "$THEOS/Prefix.pch.backup"
            cp custom.pch "$THEOS/Prefix.pch"
            echo "✅ 使用自定义Prefix.pch" >> "${LOG_FILE}"
          fi
          
          # 尝试构建
          echo "开始构建..." >> "${LOG_FILE}"
          
          # 显示make版本
          make --version >> "${LOG_FILE}" 2>&1 || echo "make命令不可用" >> "${LOG_FILE}"
          
          # 首先运行make clean
          make clean 2>&1 >> "${LOG_FILE}" || echo "⚠️ make clean失败，继续构建" >> "${LOG_FILE}"
          
          # 尝试使用更简单的编译命令
          echo "运行 make 编译..." >> "${LOG_FILE}"
          
          # 先尝试编译目标文件，看是否有错误
          if [ -f Tweak.x ]; then
            echo "编译Tweak.x..." >> "${LOG_FILE}"
            $THEOS/toolchain/linux/iphone/bin/clang++ \
              -c Tweak.x \
              -o .theos/obj/Tweak.o \
              -arch arm64 \
              -isysroot "$SDKROOT" \
              -I"$SDKROOT/usr/include" \
              -I"$SDKROOT/System/Library/Frameworks" \
              $CFLAGS \
              2>&1 >> "${LOG_FILE}" || echo "❌ 编译失败" >> "${LOG_FILE}"
          fi
          
          # 然后运行make package
          echo "运行 make package..." >> "${LOG_FILE}"
          make package 2>&1 >> "${LOG_FILE}" || {
            echo "❌ 构建失败" >> "${LOG_FILE}"
            echo "调试信息：" >> "${LOG_FILE}"
            echo "当前目录: $(pwd)" >> "${LOG_FILE}"
            echo "Makefile内容:" >> "${LOG_FILE}"
            cat Makefile 2>&1 >> "${LOG_FILE}" || echo "没有Makefile" >> "${LOG_FILE}"
          }
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
          fi

      # 步骤8：上传构建产物
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Artifacts
          path: |
            ${{ github.workspace }}/packages/*.deb
            ${{ github.workspace }}/workflow-logs/error.log
          if-no-files-found: warn
          retention-days: 7

      # 步骤9：上传详细日志
      - name: Upload Detailed Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Detailed-Logs
          path: |
            ${{ github.workspace }}/workflow-logs/
            ~/theos/
          if-no-files-found: ignore
          retention-days: 7
