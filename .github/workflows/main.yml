name: Build YoudaoNote VIP Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew install ldid dpkg
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
      
      - name: Build Tweak
        run: |
          cd $GITHUB_WORKSPACE
          
          # 设置环境变量
          export THEOS=$HOME/theos
          export THEOS_PACKAGE_SCHEME=rootless
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
          
          echo "===== 开始编译 ====="
          make clean || true
          
          echo "===== 开始编译（只编译不打包）===="
          make all || {
            echo "编译失败，查看日志："
            tail -100 .theos/build.log 2>/dev/null || true
            exit 1
          }
          
          echo "===== 尝试打包 ====="
          # 使用 FINALPACKAGE=1 跳过 dm.pl 检查
          make package FINALPACKAGE=1 || {
            echo "标准打包失败，尝试手动打包..."
            # 手动创建 .deb 包
            if [ -d ".theos/obj/deb" ]; then
              mkdir -p packages
              dpkg-deb -b .theos/obj/deb packages/
              echo "手动打包完成"
            else
              echo "错误：找不到 .theos/obj/deb 目录"
              exit 1
            fi
          }
          
          echo "检查结果..."
          if ls packages/*.deb 2>/dev/null; then
            echo "✅ 构建成功！"
            ls -la packages/*.deb
          else
            echo "❌ 未生成 .deb 文件"
            exit 1
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YNCloudNoteVIP-Tweak
          path: packages/*.deb
