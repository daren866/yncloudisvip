name: Build YoudaoNote VIP Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew install ldid dpkg
          git clone --depth=1 https://github.com/theos/theos.git $HOME/theos
          git clone --depth=1 https://github.com/xybp888/iOS-SDKs.git $HOME/iOS-SDKs
          mkdir -p $HOME/theos/sdks
          cp -r $HOME/iOS-SDKs/iPhoneOS15.5.sdk $HOME/theos/sdks/
      
      - name: Initialize Theos Vendor Directory
        run: |
          cd $HOME/theos
          # 此命令会拉取构建所需的子模块（如libroot）
          git submodule update --init --recursive
          echo "✅ Theos vendor 目录初始化完成。"
             - name: Patch Theos for XZ Compression
        run: |
          # 找到 Theos 的打包规则文件
          THEOS_PACKAGE_RULES_FILE="$HOME/theos/makefiles/package/deb.mk"
          
          if [ ! -f "$THEOS_PACKAGE_RULES_FILE" ]; then
            echo "❌ 找不到 Theos 的打包规则文件: $THEOS_PACKAGE_RULES_FILE"
            exit 1
          fi
          
          # 创建一个补丁，将内部调用的压缩参数从 lzma 改为 xz
          # 关键：找到并替换 _THEOS_PLATFORM_DPKG_DEB_COMPRESSION 的内部定义
          sed -i.bak 's/lzma/xz/g' "$THEOS_PACKAGE_RULES_FILE"
          echo "✅ 已尝试修改 Theos 内部打包规则，将 lzma 替换为 xz。"
          
          # 额外安全措施：直接覆盖可能存在的旧压缩配置
          echo "THEOS_PACKAGE_COMPRESSION = xz" > "$HOME/theos/makefiles/common.mk.tmp"
          cat "$HOME/theos/makefiles/common.mk" >> "$HOME/theos/makefiles/common.mk.tmp"
          mv "$HOME/theos/makefiles/common.mk.tmp" "$HOME/theos/makefiles/common.mk"
          echo "✅ 已确保全局配置强制设为 xz。"
       
       - name: Build Tweak
        run: |
          cd $GITHUB_WORKSPACE
               # 1. 彻底清除 Theos 的构建缓存，确保读取新配置
              rm -rf .theos
              # 2. 执行标准清理
              make clean || true
          # 设置环境变量
          export THEOS=$HOME/theos
          export THEOS_PACKAGE_SCHEME=rootless
          export SDKROOT=$HOME/theos/sdks/iPhoneOS15.5.sdk
          
          echo "===== 开始编译 ====="
          make clean || true
          
          echo "===== 开始编译（只编译不打包）===="
          make all || {
            echo "编译失败，查看日志："
            tail -100 .theos/build.log 2>/dev/null || true
            exit 1
          }
          
          echo "===== 尝试打包 ====="
          # 使用 FINALPACKAGE=1 跳过 dm.pl 检查
          make package FINALPACKAGE=1 || {
            echo "标准打包失败，尝试手动打包..."
            # 手动创建 .deb 包
            if [ -d ".theos/obj/deb" ]; then
              mkdir -p packages
              dpkg-deb -b .theos/obj/deb packages/
              echo "手动打包完成"
            else
              echo "错误：找不到 .theos/obj/deb 目录"
              exit 1
            fi
          }
          
          echo "检查结果..."
          if ls packages/*.deb 2>/dev/null; then
            echo "✅ 构建成功！"
            ls -la packages/*.deb
          else
            echo "❌ 未生成 .deb 文件"
            exit 1
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YNCloudNoteVIP-Tweak
          path: packages/*.deb
