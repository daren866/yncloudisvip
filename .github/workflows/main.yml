name: Build YoudaoNote VIP Tweak
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      # 步骤1：检出代码（第一步做）
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：创建日志文件
      - name: Create Log File
        run: |
          # 使用GitHub Actions的工作空间变量
          WORKSPACE="${{ github.workspace }}"
          LOG_DIR="${WORKSPACE}/workflow-logs"
          LOG_FILE="${LOG_DIR}/error.log"
          
          # 创建目录和文件
          mkdir -p "${LOG_DIR}"
          touch "${LOG_FILE}"
          
          # 写入初始日志
          echo "=== Workflow Start: $(date) ===" > "${LOG_FILE}"
          echo "✅ 日志创建成功：${LOG_FILE}" >> "${LOG_FILE}"
          
          # 设置环境变量
          echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          echo "WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV

      # 步骤3：Git配置
      - name: Git Setup
        run: |
          # 先确保日志文件存在
          WORKSPACE="${{ env.WORKSPACE }}"
          LOG_FILE="${{ env.LOG_FILE }}"
          
          if [ ! -f "${LOG_FILE}" ]; then
            LOG_FILE="${WORKSPACE}/workflow-logs/error.log"
            touch "${LOG_FILE}"
            echo "LOG_FILE=${LOG_FILE}" >> $GITHUB_ENV
          fi
          
          # Git配置
          git config --global credential.helper "false"
          git config --global url."https://github.com/".insteadOf git@github.com:
          echo "✅ Git配置完成" >> "${LOG_FILE}"

      # 步骤4：安装Xcode命令行工具和基础工具
      - name: Install Xcode and Tools
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          echo "=== 安装Xcode和工具 ===" >> "${LOG_FILE}"
          
          # 检查Xcode
          if ! xcode-select -p &>/dev/null; then
            echo "安装Xcode命令行工具..." >> "${LOG_FILE}"
            sudo xcode-select --install 2>&1 >> "${LOG_FILE}" || echo "Xcode可能已安装" >> "${LOG_FILE}"
          fi
          
          # 设置Xcode路径
          sudo xcode-select --switch /Applications/Xcode.app 2>&1 >> "${LOG_FILE}" || true
          sudo xcodebuild -license accept 2>&1 >> "${LOG_FILE}"
          
          # 安装Homebrew工具
          echo "安装Homebrew工具..." >> "${LOG_FILE}"
          brew update 2>&1 >> "${LOG_FILE}"
          brew install ldid dpkg git curl wget make 2>&1 >> "${LOG_FILE}"
          
          echo "✅ Xcode和工具安装完成" >> "${LOG_FILE}"

      # 步骤5：获取SDK路径
      - name: Get SDK Paths
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          echo "=== 获取SDK路径 ===" >> "${LOG_FILE}"
          
          # 获取macOS SDK路径
          MACOS_SDK_PATH=$(xcrun --sdk macosx --show-sdk-path 2>/dev/null || echo "")
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH" ]; then
            echo "MACOS_SDK_PATH=${MACOS_SDK_PATH}" >> $GITHUB_ENV
            echo "✅ 获取到macOS SDK路径: ${MACOS_SDK_PATH}" >> "${LOG_FILE}"
          else
            echo "❌ 无法获取macOS SDK路径" >> "${LOG_FILE}"
          fi
          
          # 获取iOS SDK路径
          IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path 2>/dev/null || echo "")
          if [ -n "$IOS_SDK_PATH" ] && [ -d "$IOS_SDK_PATH" ]; then
            echo "IOS_SDK_PATH=${IOS_SDK_PATH}" >> $GITHUB_ENV
            echo "✅ 获取到iOS SDK路径: ${IOS_SDK_PATH}" >> "${LOG_FILE}"
          else
            echo "⚠️ 无法获取iOS SDK路径，将使用下载的SDK" >> "${LOG_FILE}"
          fi

      # 步骤6：安装和配置Theos
      - name: Setup Theos
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          echo "=== 安装Theos ===" >> "${LOG_FILE}"
          
          # 清理旧环境
          rm -rf ~/theos ~/ellekit ~/iOS-SDKs
          
          # 克隆Theos
          echo "正在克隆Theos..." >> "${LOG_FILE}"
          git clone --recursive --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}"
          
          # 克隆iOS-SDKs
          echo "正在克隆iOS-SDKs..." >> "${LOG_FILE}"
          git clone --depth 1 https://github.com/xybp888/iOS-SDKs.git ~/iOS-SDKs 2>&1 >> "${LOG_FILE}"
          
          # 创建sdks目录
          mkdir -p ~/theos/sdks
          
          # 复制完整的SDK
          if [ -d ~/iOS-SDKs/iPhoneOS14.4.sdk ]; then
            echo "复制iPhoneOS14.4.sdk..." >> "${LOG_FILE}"
            cp -r ~/iOS-SDKs/iPhoneOS14.4.sdk ~/theos/sdks/
          elif [ -d ~/iOS-SDKs/iPhoneOS15.5.sdk ]; then
            echo "复制iPhoneOS15.5.sdk..." >> "${LOG_FILE}"
            cp -r ~/iOS-SDKs/iPhoneOS15.5.sdk ~/theos/sdks/
          fi
          
          echo "✅ Theos安装完成" >> "${LOG_FILE}"

      # 步骤7：安装和配置Ellekit
      - name: Setup Ellekit
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          echo "=== 安装Ellekit ===" >> "${LOG_FILE}"
          
          # 克隆Ellekit
          git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}"
          
          # 创建ellekit目录
          mkdir -p ~/theos/vendor/ellekit
          
          # 复制头文件和库文件
          if [ -d ~/ellekit/include ]; then
            cp -r ~/ellekit/include ~/theos/vendor/ellekit/
            echo "✅ Ellekit头文件复制完成" >> "${LOG_FILE}"
          fi
          
          if [ -d ~/ellekit/lib ]; then
            cp -r ~/ellekit/lib ~/theos/vendor/ellekit/
            echo "✅ Ellekit库文件复制完成" >> "${LOG_FILE}"
          fi
          
          echo "✅ Ellekit安装完成" >> "${LOG_FILE}"

      # 步骤8：修复头文件问题
      - name: Fix Header Issues
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          echo "=== 修复头文件问题 ===" >> "${LOG_FILE}"
          
          # 获取macOS SDK路径
          MACOS_SDK_PATH="${{ env.MACOS_SDK_PATH }}"
          THEOS_PATH=~/theos
          
          # 如果macOS SDK存在，复制mach-o头文件
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH/usr/include/mach-o" ]; then
            echo "复制mach-o头文件..." >> "${LOG_FILE}"
            mkdir -p $THEOS_PATH/include/mach-o
            cp -r "$MACOS_SDK_PATH/usr/include/mach-o/"* $THEOS_PATH/include/mach-o/ 2>&1 >> "${LOG_FILE}"
            echo "✅ mach-o头文件复制完成" >> "${LOG_FILE}"
          fi
          
          echo "✅ 头文件修复完成" >> "${LOG_FILE}"

      # 步骤9：编译打包
      - name: Build Package
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          WORKSPACE="${{ env.WORKSPACE }}"
          
          echo "=== 编译打包 ===" >> "${LOG_FILE}"
          
          cd "${WORKSPACE}"
          
          # 修复deb.mk
          DEB_MK=~/theos/makefiles/package/deb.mk
          if [ -f "${DEB_MK}" ]; then
            sed -i '' 's/COPYFILE_DISABLE=1.*/COPYFILE_DISABLE=1 $(FAKEROOT) -r dm.pl $(THEOS_PLATFORM_DPKG_DEB_COMPRESSION_FLAG) $(DPKGDEB_FLAGS) -b "$(_THEOS_PLATFORM_DPKG_DEB_BUILD_DPKG_FAKEROOT_PATH)" "$(THEOS_PACKAGE_DIR)/$(PACKAGE_FILENAME)"/' "${DEB_MK}"
            echo "✅ deb.mk修复完成" >> "${LOG_FILE}"
          fi
          
          # 清理旧构建
          rm -rf .theos packages
          
          # 设置环境变量
          export THEOS=~/theos
          export ARCHS=arm64
          export TARGET=iphone:clang:14.4:10.0
          export THEOS_PACKAGE_SCHEME=rootless
          
          # 设置SDK路径 - 优先使用Xcode自带的SDK
          IOS_SDK_PATH="${{ env.IOS_SDK_PATH }}"
          if [ -n "$IOS_SDK_PATH" ] && [ -d "$IOS_SDK_PATH" ]; then
            export SDKROOT="$IOS_SDK_PATH"
            echo "✅ 使用Xcode iOS SDK: $SDKROOT" >> "${LOG_FILE}"
          elif [ -d ~/theos/sdks/iPhoneOS14.4.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS14.4.sdk
            echo "✅ 使用下载的iOS SDK 14.4" >> "${LOG_FILE}"
          elif [ -d ~/theos/sdks/iPhoneOS15.5.sdk ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS15.5.sdk
            echo "✅ 使用下载的iOS SDK 15.5" >> "${LOG_FILE}"
          else
            echo "❌ 未找到可用的SDK" >> "${LOG_FILE}"
            exit 1
          fi
          
          # Ellekit依赖
          export CFLAGS="-Wno-error -fobjc-arc"
          if [ -d ~/theos/vendor/ellekit/include ]; then
            export CFLAGS="$CFLAGS -I~/theos/vendor/ellekit/include"
          fi
          
          export LDFLAGS="-Wl,-dead_strip"
          if [ -d ~/theos/vendor/ellekit/lib ]; then
            export LDFLAGS="$LDFLAGS -L~/theos/vendor/ellekit/lib -lEllekit"
          fi
          
          # 添加macOS SDK路径到编译选项
          MACOS_SDK_PATH="${{ env.MACOS_SDK_PATH }}"
          if [ -n "$MACOS_SDK_PATH" ]; then
            export CFLAGS="$CFLAGS -I$MACOS_SDK_PATH/usr/include"
          fi
          
          # 生成control文件
          echo "Package: com.yncloudnote.vip.tweak" > control
          echo "Name: YNCloudNoteVIP" >> control
          echo "Version: 1.0.0" >> control
          echo "Architecture: iphoneos-arm64" >> control
          echo "Description: YoudaoNote VIP Tweak" >> control
          echo "Author: Your Name" >> control
          echo "Maintainer: Your Name" >> control
          echo "Section: Tweaks" >> control
          echo "Depends: ellekit" >> control
          echo "Rootless: true" >> control
          
          # 执行打包
          echo "开始编译..." >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          echo "CFLAGS: $CFLAGS" >> "${LOG_FILE}"
          
          make package 2>&1 >> "${LOG_FILE}" || {
            echo "❌ 构建失败" >> "${LOG_FILE}"
            echo "最后50行日志：" >> "${LOG_FILE}"
            tail -50 "${LOG_FILE}" >> "${LOG_FILE}"
          }
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
          fi

      # 步骤10：上传产物
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Output
          path: |
            ${{ github.workspace }}/packages/*.deb
            ${{ github.workspace }}/workflow-logs/error.log
          if-no-files-found: warn
          retention-days: 7

      # 步骤11：上传详细日志
      - name: Upload Detailed Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Detailed-Logs
          path: |
            ${{ github.workspace }}/workflow-logs/
          if-no-files-found: ignore
          retention-days: 7
