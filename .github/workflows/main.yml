name: Build YoudaoNote VIP Tweak
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 20
    continue-on-error: true

    steps:
      # 步骤0：强制创建日志
      - name: Create Log File
        run: |
          LOG_DIR="/Users/runner/work/yncloudisvip/yncloudisvip/workflow-logs"
          MAIN_LOG="${LOG_DIR}/error.log"
          
          # 创建目录和日志文件
          mkdir -p "${LOG_DIR}"
          touch "${MAIN_LOG}"
          
          echo "LOG_FILE=${MAIN_LOG}" >> $GITHUB_ENV
          echo "=== Workflow Start: $(date) ===" > "${MAIN_LOG}"
          echo "✅ 日志创建成功：${MAIN_LOG}" >> "${MAIN_LOG}"
        continue-on-error: true

      # 步骤1：Git配置 + 拉取主仓库
      - name: Git Setup & Checkout
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          git config --global credential.helper "false"
          git config --global url."https://github.com/".insteadOf git@github.com:
          echo "✅ Git配置完成" >> "${LOG_FILE}"
        continue-on-error: true
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
        continue-on-error: true

      # 步骤2：安装Xcode命令行工具和基础工具
      - name: Install Xcode and Tools
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          # 安装Xcode命令行工具
          sudo xcode-select --install 2>&1 >> "${LOG_FILE}" || true
          
          # 设置Xcode路径
          sudo xcode-select --switch /Applications/Xcode.app 2>&1 >> "${LOG_FILE}" || true
          
          # 接受许可协议
          sudo xcodebuild -license accept 2>&1 >> "${LOG_FILE}"
          
          # 安装Homebrew工具
          brew update 2>&1 >> "${LOG_FILE}"
          brew install ldid dpkg git curl wget make 2>&1 >> "${LOG_FILE}"
          
          echo "✅ Xcode和工具安装完成" >> "${LOG_FILE}"
        continue-on-error: true

      # 步骤3：获取macOS SDK路径
      - name: Get macOS SDK Path
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          # 获取macOS SDK路径（用于mach-o头文件）
          MACOS_SDK_PATH=$(xcrun --sdk macosx --show-sdk-path 2>&1 | head -1)
          
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH" ]; then
            echo "MACOS_SDK_PATH=${MACOS_SDK_PATH}" >> $GITHUB_ENV
            echo "✅ 获取到macOS SDK路径: ${MACOS_SDK_PATH}" >> "${LOG_FILE}"
          else
            echo "❌ 无法获取macOS SDK路径" >> "${LOG_FILE}"
          fi
        continue-on-error: true

      # 步骤4：安装和配置Theos
      - name: Setup Theos
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          set +e
          
          # 清理旧环境
          rm -rf ~/theos ~/ellekit ~/iOS-SDKs
          
          # 克隆Theos
          echo "正在克隆Theos..." >> "${LOG_FILE}"
          git clone --recursive --depth 1 https://github.com/theos/theos.git ~/theos 2>&1 >> "${LOG_FILE}"
          
          # 克隆iOS-SDKs
          echo "正在克隆iOS-SDKs..." >> "${LOG_FILE}"
          git clone --depth 1 https://github.com/xybp888/iOS-SDKs.git ~/iOS-SDKs 2>&1 >> "${LOG_FILE}"
          
          # 创建sdks目录
          mkdir -p ~/theos/sdks
          
          # 复制完整的SDK（包含所有头文件）
          if [ -d ~/iOS-SDKs/iPhoneOS14.4.sdk ]; then
            echo "复制iPhoneOS14.4.sdk..." >> "${LOG_FILE}"
            cp -r ~/iOS-SDKs/iPhoneOS14.4.sdk ~/theos/sdks/
            
            # 检查SDK完整性
            SDK_PATH=~/theos/sdks/iPhoneOS14.4.sdk
            if [ -d "$SDK_PATH/System/Library/Frameworks/CoreFoundation.framework" ]; then
              echo "✅ SDK包含CoreFoundation.framework" >> "${LOG_FILE}"
            else
              echo "❌ SDK缺少CoreFoundation.framework" >> "${LOG_FILE}"
            fi
            
            if [ -d "$SDK_PATH/usr/include" ]; then
              echo "✅ SDK包含usr/include目录" >> "${LOG_FILE}"
            else
              echo "❌ SDK缺少usr/include目录" >> "${LOG_FILE}"
            fi
          fi
          
          echo "✅ Theos安装完成" >> "${LOG_FILE}"
        continue-on-error: true

      # 步骤5：安装和配置Ellekit
      - name: Setup Ellekit
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          # 克隆Ellekit
          git clone --depth 1 https://github.com/tealbathingsuit/ellekit.git ~/ellekit 2>&1 >> "${LOG_FILE}"
          
          # 创建ellekit目录
          mkdir -p ~/theos/vendor/ellekit
          
          # 复制头文件和库文件
          if [ -d ~/ellekit/include ]; then
            cp -r ~/ellekit/include ~/theos/vendor/ellekit/
            echo "✅ Ellekit头文件复制完成" >> "${LOG_FILE}"
          fi
          
          if [ -d ~/ellekit/lib ]; then
            cp -r ~/ellekit/lib ~/theos/vendor/ellekit/
            echo "✅ Ellekit库文件复制完成" >> "${LOG_FILE}"
          fi
          
          echo "✅ Ellekit安装完成" >> "${LOG_FILE}"
        continue-on-error: true

      # 步骤6：修复头文件问题
      - name: Fix Header Issues
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          
          # 获取macOS SDK路径
          MACOS_SDK_PATH="${{ env.MACOS_SDK_PATH }}"
          THEOS_PATH=~/theos
          
          # 如果macOS SDK存在，复制mach-o头文件
          if [ -n "$MACOS_SDK_PATH" ] && [ -d "$MACOS_SDK_PATH/usr/include/mach-o" ]; then
            echo "复制mach-o头文件..." >> "${LOG_FILE}"
            
            # 创建目录
            mkdir -p $THEOS_PATH/include/mach-o
            
            # 复制mach-o头文件
            cp -r "$MACOS_SDK_PATH/usr/include/mach-o/"* $THEOS_PATH/include/mach-o/ 2>&1 >> "${LOG_FILE}"
            echo "✅ mach-o头文件复制完成" >> "${LOG_FILE}"
          else
            echo "⚠️ 无法获取macOS SDK或缺少mach-o头文件" >> "${LOG_FILE}"
          fi
          
          # 修复SDK中的头文件链接
          SDK_PATH=~/theos/sdks/iPhoneOS14.4.sdk
          if [ -d "$SDK_PATH" ]; then
            echo "修复SDK头文件链接..." >> "${LOG_FILE}"
            
            # 确保usr/include目录存在
            if [ ! -d "$SDK_PATH/usr/include" ]; then
              mkdir -p "$SDK_PATH/usr/include"
            fi
            
            # 如果缺少mach-o目录，从macOS SDK复制
            if [ ! -d "$SDK_PATH/usr/include/mach-o" ] && [ -d "$THEOS_PATH/include/mach-o" ]; then
              cp -r "$THEOS_PATH/include/mach-o" "$SDK_PATH/usr/include/"
              echo "✅ 复制mach-o头文件到SDK" >> "${LOG_FILE}"
            fi
            
            # 检查关键头文件
            echo "检查关键头文件：" >> "${LOG_FILE}"
            
            # CoreFoundation.h
            if find "$SDK_PATH" -name "CoreFoundation.h" 2>/dev/null | head -1; then
              echo "✅ 找到CoreFoundation.h" >> "${LOG_FILE}"
            else
              echo "❌ 未找到CoreFoundation.h" >> "${LOG_FILE}"
            fi
            
            # Foundation.h
            if find "$SDK_PATH" -name "Foundation.h" 2>/dev/null | head -1; then
              echo "✅ 找到Foundation.h" >> "${LOG_FILE}"
            else
              echo "❌ 未找到Foundation.h" >> "${LOG_FILE}"
            fi
            
            # nlist.h
            if find "$SDK_PATH" -name "nlist.h" 2>/dev/null | head -1; then
              echo "✅ 找到nlist.h" >> "${LOG_FILE}"
            else
              echo "❌ 未找到nlist.h" >> "${LOG_FILE}"
            fi
          fi
          
          echo "✅ 头文件修复完成" >> "${LOG_FILE}"
        continue-on-error: true

      # 步骤7：编译打包
      - name: Build Package
        shell: /bin/bash
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          set +e
          
          # 修复deb.mk
          DEB_MK=~/theos/makefiles/package/deb.mk
          if [ -f "${DEB_MK}" ]; then
            sed -i '' 's/COPYFILE_DISABLE=1.*/COPYFILE_DISABLE=1 $(FAKEROOT) -r dm.pl $(THEOS_PLATFORM_DPKG_DEB_COMPRESSION_FLAG) $(DPKGDEB_FLAGS) -b "$(_THEOS_PLATFORM_DPKG_DEB_BUILD_DPKG_FAKEROOT_PATH)" "$(THEOS_PACKAGE_DIR)/$(PACKAGE_FILENAME)"/' "${DEB_MK}"
            echo "✅ deb.mk修复完成" >> "${LOG_FILE}"
          fi
          
          # 编译配置
          cd /Users/runner/work/yncloudisvip/yncloudisvip || exit 0
          rm -rf .theos packages
          
          export THEOS=~/theos
          export ARCHS=arm64
          export TARGET=iphone:clang:14.4:10.0
          export THEOS_PACKAGE_SCHEME=rootless
          export SDKROOT=~/theos/sdks/iPhoneOS14.4.sdk
          
          # 如果SDK不存在，尝试其他版本
          if [ ! -d "${SDKROOT}" ]; then
            export SDKROOT=~/theos/sdks/iPhoneOS15.5.sdk
          fi
          
          # Ellekit依赖
          export CFLAGS="-Wno-error -fobjc-arc -I~/theos/vendor/ellekit/include"
          export LDFLAGS="-Wl,-dead_strip -L~/theos/vendor/ellekit/lib -lEllekit"
          
          # 添加macOS SDK的头文件路径到编译选项
          MACOS_SDK_PATH="${{ env.MACOS_SDK_PATH }}"
          if [ -n "$MACOS_SDK_PATH" ]; then
            export CFLAGS="$CFLAGS -I$MACOS_SDK_PATH/usr/include"
          fi
          
          # 生成control文件
          cat > control << EOF
            Package: com.yncloudnote.vip.tweak
            Name: YNCloudNoteVIP
            Version: 0.0.1-1
            Architecture: iphoneos-arm
            Description: YoudaoNote VIP Tweak
            Author: Your Name
            Maintainer: Your Name
            Section: Tweaks
            Depends: ellekit (>= 1.0)
            Rootless: yes
          EOF
          
          # 执行打包
          echo "开始编译..." >> "${LOG_FILE}"
          echo "SDKROOT: $SDKROOT" >> "${LOG_FILE}"
          echo "CFLAGS: $CFLAGS" >> "${LOG_FILE}"
          echo "LDFLAGS: $LDFLAGS" >> "${LOG_FILE}"
          
          make package V=2 2>&1 >> "${LOG_FILE}"
          
          # 检查结果
          if ls packages/*.deb 1>/dev/null 2>&1; then
            echo "✅ 构建成功！生成的deb包：" >> "${LOG_FILE}"
            ls -la packages/*.deb >> "${LOG_FILE}"
          else
            echo "❌ 构建失败，未生成deb包" >> "${LOG_FILE}"
            echo "编译日志：" >> "${LOG_FILE}"
            tail -50 "${LOG_FILE}" | grep -A 50 "error:\|Error:\|fatal error:" >> "${LOG_FILE}"
          fi
        continue-on-error: true

      # 步骤8：上传产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-Output
          path: |
            /Users/runner/work/yncloudisvip/yncloudisvip/packages/*.deb
            /Users/runner/work/yncloudisvip/yncloudisvip/workflow-logs/error.log
          if-no-files-found: warn
        continue-on-error: true

      # 步骤9：强制成功
      - name: Force Success
        run: |
          LOG_FILE="${{ env.LOG_FILE }}"
          echo "✅ Workflow completed at $(date)" >> "${LOG_FILE}"
          exit 0
        continue-on-error: true
